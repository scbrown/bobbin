id: django-004
repo: django/django
commit: 953095d1e603fe0f8f01175b1409ca23818dcff9
description: |
  Fix IntegrityError in `bulk_create()` for models with
  `order_with_respect_to`. The `_order` column is left as NULL during
  bulk_create, causing an IntegrityError because the column is NOT NULL.
  The regular `save()` method handles this by computing the next order
  value, but `bulk_create()` bypasses that logic. Add a new
  `_handle_order_with_respect_to()` method to `QuerySet` that groups
  objects by their parent FK, queries the current max `_order` for each
  group, and assigns sequential order values before insertion. Also fix
  `contenttypes/fields.py` where `get_filter_kwargs_for_object` uses
  the wrong attribute name for ContentType foreign keys (should use
  `ct_field_attname` not `ct_field`). This is a cross-file fix across
  `query.py` and `contenttypes/fields.py`.
setup_command: "python3 -m venv .venv && .venv/bin/pip install -e . --quiet"
test_command: "cd tests && ../.venv/bin/python -m django test order_with_respect_to --settings=test_sqlite"
language: python
difficulty: hard
tags: [bug-fix, orm, bulk-create, order-with-respect-to, cross-file]
